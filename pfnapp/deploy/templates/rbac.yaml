{{- if and .Values.rbac .Values.rbac.enabled }}
{{- $roleKind := default "ClusterRole" .Values.rbac.kind }}
{{- $roleName := printf "%s-access" (include "deploy.fullname" .) }}
{{- $rules := .Values.rbac.rules }}
{{- $createServiceAccount := or .Values.serviceAccount.create (and .Values.rbac .Values.rbac.enabled (not .Values.serviceAccount.name)) -}}
{{- if not (and $rules (gt (len $rules) 0)) }}
{{- fail "Values.rbac.rules must be provided when rbac.enabled is true" }}
{{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: {{ $roleKind }}
metadata:
  name: {{ $roleName }}
  labels:
    {{- include "deploy.labels" . | nindent 4 }}
rules:
{{- toYaml $rules | nindent 2 }}
{{- $bindingKind := ternary "ClusterRoleBinding" "RoleBinding" (eq $roleKind "ClusterRole") }}
{{- $bindingName := printf "%s-binding" $roleName }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: {{ $bindingKind }}
metadata:
  name: {{ $bindingName }}
  labels:
    {{- include "deploy.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: {{ $roleKind }}
  name: {{ $roleName }}
subjects:
{{- if or $createServiceAccount .Values.serviceAccount.name }}
  - kind: ServiceAccount
    name: {{ include "deploy.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
{{- else }}
{{- fail "RBAC binding requires a serviceAccount when rbac.enabled is true" }}
{{- end }}
{{- $namespaceRole := .Values.rbac.namespaceRole }}
{{- if and $namespaceRole $namespaceRole.enabled }}
{{- $namespaceRoleName := printf "%s-namespace-access" (include "deploy.fullname" .) }}
{{- $namespaceRules := $namespaceRole.rules }}
{{- if not (and $namespaceRules (gt (len $namespaceRules) 0)) }}
{{- fail "Values.rbac.namespaceRole.rules must be provided when namespaceRole.enabled is true" }}
{{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ $namespaceRoleName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "deploy.labels" . | nindent 4 }}
rules:
{{- toYaml $namespaceRules | nindent 2 }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ printf "%s-binding" $namespaceRoleName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "deploy.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ $namespaceRoleName }}
subjects:
  - kind: ServiceAccount
    name: {{ include "deploy.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
{{- end }}
{{- end }}
