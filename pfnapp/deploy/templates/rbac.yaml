{{- $root := . -}}
{{- $rbacConfig := $root.Values.rbac -}}
{{- $rolesData := dict "roles" (list) -}}
{{- if kindIs "map" $rbacConfig -}}
  {{- if or $rbacConfig.enabled (and $rbacConfig.namespaceRole $rbacConfig.namespaceRole.enabled) -}}
    {{- if $rbacConfig.enabled -}}
      {{- $rules := $rbacConfig.rules -}}
      {{- if not (and $rules (gt (len $rules) 0)) -}}
        {{- fail "Values.rbac.rules must be provided when rbac.enabled is true" -}}
      {{- end -}}
      {{- $roleKind := default "ClusterRole" $rbacConfig.kind -}}
      {{- $roleDict := dict "kind" $roleKind "rules" $rules "name" (printf "%s-access" (include "deploy.fullname" $root)) "bindingEnabled" true "bindingKind" (ternary "ClusterRoleBinding" "RoleBinding" (eq $roleKind "ClusterRole")) "bindingName" (printf "%s-access-binding" (include "deploy.fullname" $root)) "namespace" $root.Release.Namespace -}}
      {{- $_ := set $rolesData "roles" (append (get $rolesData "roles") $roleDict) -}}
    {{- end -}}
    {{- $namespaceRole := $rbacConfig.namespaceRole -}}
    {{- if and $namespaceRole $namespaceRole.enabled -}}
      {{- $namespaceRules := $namespaceRole.rules -}}
      {{- if not (and $namespaceRules (gt (len $namespaceRules) 0)) -}}
        {{- fail "Values.rbac.namespaceRole.rules must be provided when namespaceRole.enabled is true" -}}
      {{- end -}}
      {{- $nsDict := dict "kind" "Role" "rules" $namespaceRules "name" (printf "%s-namespace-access" (include "deploy.fullname" $root)) "bindingEnabled" true "bindingKind" "RoleBinding" "bindingName" (printf "%s-namespace-access-binding" (include "deploy.fullname" $root)) "namespace" $root.Release.Namespace -}}
      {{- $_ := set $rolesData "roles" (append (get $rolesData "roles") $nsDict) -}}
    {{- end -}}
  {{- end -}}
{{- else if kindIs "slice" $rbacConfig -}}
  {{- range $index, $entry := $rbacConfig -}}
    {{- if and (kindIs "map" $entry) (ne (default true $entry.enabled) false) -}}
      {{- $rules := $entry.rules -}}
      {{- if not (and $rules (gt (len $rules) 0)) -}}
        {{- fail (printf "Values.rbac[%d].rules must be provided when enabled is true" $index) -}}
      {{- end -}}
      {{- $kind := default "ClusterRole" $entry.kind -}}
      {{- $name := default (printf "%s-rbac-%d" (include "deploy.fullname" $root) (add $index 1)) $entry.name -}}
      {{- $bindingEnabled := ne (default true $entry.bindingEnabled) false -}}
      {{- $bindingKind := default (ternary "ClusterRoleBinding" "RoleBinding" (eq $kind "ClusterRole")) $entry.bindingKind -}}
      {{- $bindingName := default (printf "%s-binding" $name) $entry.bindingName -}}
      {{- $namespace := default $root.Release.Namespace $entry.namespace -}}
      {{- $roleDict := dict "kind" $kind "rules" $rules "name" $name "bindingEnabled" $bindingEnabled "bindingKind" $bindingKind "bindingName" $bindingName "namespace" $namespace "subjects" $entry.subjects "labels" $entry.labels "annotations" $entry.annotations -}}
      {{- $_ := set $rolesData "roles" (append (get $rolesData "roles") $roleDict) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $roles := get $rolesData "roles" -}}
{{- if gt (len $roles) 0 -}}
  {{- range $index, $role := $roles -}}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: {{ $role.kind }}
metadata:
  name: {{ $role.name }}
  {{- if and (eq $role.kind "Role") $role.namespace }}
  namespace: {{ $role.namespace }}
  {{- end }}
  labels:
    {{- include "deploy.labels" $root | nindent 4 }}
    {{- with $role.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with $role.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
rules:
{{- toYaml $role.rules | nindent 2 }}
  {{- if $role.bindingEnabled }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: {{ $role.bindingKind }}
metadata:
  name: {{ $role.bindingName }}
  {{- if and (eq $role.bindingKind "RoleBinding") $role.namespace }}
  namespace: {{ $role.namespace }}
  {{- end }}
  labels:
    {{- include "deploy.labels" $root | nindent 4 }}
    {{- with $role.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with $role.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: {{ $role.kind }}
  name: {{ $role.name }}
subjects:
{{- if and $role.subjects (gt (len $role.subjects) 0) }}
{{- toYaml $role.subjects | nindent 2 }}
{{- else }}
  - kind: ServiceAccount
    name: {{ include "deploy.serviceAccountName" $root }}
    namespace: {{ if eq $role.bindingKind "ClusterRoleBinding" }}{{ $root.Release.Namespace }}{{ else }}{{ default $root.Release.Namespace $role.namespace }}{{ end }}
{{- end }}
{{ end }}
{{- end }}
{{- end }}
